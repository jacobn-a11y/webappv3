generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Auth & Tenancy ──────────────────────────────────────────────────────────

model Organization {
  id               String          @id @default(cuid())
  name             String
  workosOrgId      String?         @unique
  stripeCustomerId String?         @unique
  plan             Plan            @default(FREE_TRIAL)
  pricingModel     PricingModel    @default(METERED)
  billingChannel   BillingChannel  @default(SELF_SERVE)
  billingEnabled   Boolean         @default(false)
  seatLimit        Int?
  trialEndsAt      DateTime?
  contractEndsAt   DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  users                User[]
  accounts             Account[]
  calls                Call[]
  stories              Story[]
  landingPages         LandingPage[]
  orgSettings          OrgSettings?
  orgAISettings        OrgAISettings?
  orgAIRoleDefaults    OrgAIRoleDefault[]
  aiProviderConfigs    AIProviderConfig[]
  aiUsageRecords       AIUsageRecord[]
  aiUsageLimits        AIUsageLimit[]
  aiUsageNotifications AIUsageNotification[]
  userAIBalances       UserAIBalance[]
  subscriptions        Subscription[]
  usageRecords         UsageRecord[]
  apiKeys              ApiKey[]
  linkedAccounts       LinkedAccount[]
  integrationConfigs   IntegrationConfig[]
  invites              OrgInvite[]
  setupWizard          SetupWizard?
  storyRegenLogs       StoryRegenLog[]
  roleProfiles         RoleProfile[]
  auditLogs            AuditLog[]
  featureFlags         OrgFeatureFlag[]
  sessions             UserSession[]
  ipAllowlistEntries   OrgIpAllowlistEntry[]
  scimProvisioning     ScimProvisioning?
  scimIdentities       ScimIdentity[]
  approvalRequests     ApprovalRequest[]
  integrationRuns      IntegrationRun[]
  teamWorkspaces       TeamWorkspace[]
  sharedAssets         SharedAsset[]
  automationRules      AutomationRule[]
  artifactGovernancePolicy ArtifactGovernancePolicy?
  artifactApprovalSteps ArtifactApprovalStep[]
  artifactVersions     PublishedArtifactVersion[]
  approvalGroups       ApprovalGroup[]
  approvalGroupMembers ApprovalGroupMember[]
  teamApprovalAdminScopes TeamApprovalAdminScope[]
  storyQualityFeedback StoryQualityFeedback[]
  storyClaimLineage    StoryClaimLineage[]
  accountMergeRuns     AccountMergeRun[]
  supportImpersonationSessions SupportImpersonationSession[]
  incidents           Incident[]
  incidentUpdates     IncidentUpdate[]

  @@map("organizations")
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  actorUserId    String?
  category       String
  action         String
  schemaVersion  Int      @default(1)
  targetType     String?
  targetId       String?
  severity       String   @default("INFO")
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  expiresAt      DateTime?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId, category, createdAt])
  @@index([organizationId, expiresAt])
  @@map("audit_logs")
}

model Incident {
  id             String   @id @default(cuid())
  organizationId String
  title          String
  summary        String
  severity       String   @default("MEDIUM")
  status         String   @default("OPEN")
  startedAt      DateTime @default(now())
  resolvedAt     DateTime?
  createdByUserId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  updates      IncidentUpdate[]

  @@index([organizationId, status, startedAt])
  @@index([organizationId, severity, startedAt])
  @@map("incidents")
}

model IncidentUpdate {
  id             String   @id @default(cuid())
  incidentId     String
  organizationId String
  message        String
  status         String?
  metadata       Json?
  createdByUserId String?
  createdAt      DateTime @default(now())

  incident     Incident     @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([incidentId, createdAt])
  @@map("incident_updates")
}

model OrgFeatureFlag {
  id             String   @id @default(cuid())
  organizationId String
  key            String
  enabled        Boolean  @default(false)
  config         Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, key])
  @@index([organizationId, enabled])
  @@map("org_feature_flags")
}

model UserSession {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  sessionToken   String   @unique
  deviceLabel    String?
  ipAddress      String?
  userAgent      String?
  lastSeenAt     DateTime @default(now())
  revokedAt      DateTime?
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId, revokedAt])
  @@index([organizationId, expiresAt])
  @@map("user_sessions")
}

model OrgIpAllowlistEntry {
  id             String   @id @default(cuid())
  organizationId String
  cidr           String
  label          String?
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, cidr])
  @@index([organizationId, enabled])
  @@map("org_ip_allowlist_entries")
}

model ScimProvisioning {
  id                 String   @id @default(cuid())
  organizationId     String   @unique
  enabled            Boolean  @default(false)
  tokenHash          String?
  endpointSecretHint String?
  lastSyncAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("scim_provisioning")
}

model ScimIdentity {
  id             String   @id @default(cuid())
  organizationId String
  userId         String   @unique
  externalId     String
  active         Boolean  @default(true)
  lastSyncedAt   DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, externalId])
  @@index([organizationId, active])
  @@map("scim_identities")
}

model ApprovalRequest {
  id                String   @id @default(cuid())
  organizationId    String
  requestType       String
  targetType        String
  targetId          String
  requestedByUserId String
  reviewerUserId    String?
  status            String   @default("PENDING")
  requestPayload    Json?
  reviewNotes       String?
  reviewedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestedBy  User         @relation("ApprovalRequestedBy", fields: [requestedByUserId], references: [id], onDelete: Cascade)
  reviewer     User?        @relation("ApprovalReviewedBy", fields: [reviewerUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status, createdAt])
  @@index([organizationId, targetType, targetId])
  @@map("approval_requests")
}

model IntegrationRun {
  id                  String              @id @default(cuid())
  organizationId      String
  integrationConfigId String?
  provider            IntegrationProvider
  runType             String
  status              String
  idempotencyKey      String?
  startedAt           DateTime            @default(now())
  finishedAt          DateTime?
  processedCount      Int                 @default(0)
  successCount        Int                 @default(0)
  failureCount        Int                 @default(0)
  errorMessage        String?
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  integrationConfig IntegrationConfig? @relation(fields: [integrationConfigId], references: [id], onDelete: SetNull)

  @@index([organizationId, provider, startedAt])
  @@index([organizationId, status, startedAt])
  @@unique([organizationId, idempotencyKey])
  @@map("integration_runs")
}

enum Plan {
  FREE_TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum PricingModel {
  METERED
  PER_SEAT
  METERED_PLUS_SEAT
}

enum BillingChannel {
  SELF_SERVE
  SALES_LED
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  workosUserId   String?  @unique
  organizationId String
  role           UserRole @default(MEMBER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization         Organization          @relation(fields: [organizationId], references: [id])
  landingPages         LandingPage[]         @relation("CreatedBy")
  landingPageEdits     LandingPageEdit[]
  permissions          UserPermission[]
  accountAccess        UserAccountAccess[]
  aiUsageRecords       AIUsageRecord[]
  aiUsageLimits        AIUsageLimit[]
  aiUsageNotifications AIUsageNotification[]
  aiAccess             UserAIAccess[]
  aiBalance            UserAIBalance[]
  roleAssignment       UserRoleAssignment?
  sessions             UserSession[]
  scimIdentity         ScimIdentity?
  approvalRequests     ApprovalRequest[] @relation("ApprovalRequestedBy")
  approvalReviews      ApprovalRequest[] @relation("ApprovalReviewedBy")
  ownedWorkspaces      TeamWorkspace[]   @relation("WorkspaceOwner")
  ownedAssets          SharedAsset[]     @relation("AssetOwner")
  publishedArtifactVersions PublishedArtifactVersion[]
  approvalGroupsOwned  ApprovalGroup[] @relation("ApprovalGroupOwner")
  approvalGroupMemberships ApprovalGroupMember[]
  teamApprovalScopes   TeamApprovalAdminScope[] @relation("TeamApprovalScopeUser")
  submittedStoryFeedback StoryQualityFeedback[] @relation("StoryFeedbackSubmittedBy")
  supportImpersonationActorSessions SupportImpersonationSession[] @relation("SupportImpersonationActor")
  supportImpersonationTargetSessions SupportImpersonationSession[] @relation("SupportImpersonationTarget")
  supportImpersonationRevokedSessions SupportImpersonationSession[] @relation("SupportImpersonationRevokedBy")

  @@index([organizationId])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model RoleProfile {
  id                          String           @id @default(cuid())
  organizationId              String
  key                         String
  name                        String
  description                 String?
  isPreset                    Boolean          @default(false)
  permissions                 PermissionType[] @default([])
  canAccessAnonymousStories   Boolean          @default(true)
  canGenerateAnonymousStories Boolean          @default(true)
  canAccessNamedStories       Boolean          @default(false)
  canGenerateNamedStories     Boolean          @default(false)
  defaultAccountScopeType     AccountScopeType @default(ACCOUNT_LIST)
  defaultAccountIds           String[]         @default([])
  maxTokensPerDay             Int?
  maxTokensPerMonth           Int?
  maxRequestsPerDay           Int?
  maxRequestsPerMonth         Int?
  maxStoriesPerMonth          Int?
  createdAt                   DateTime         @default(now())
  updatedAt                   DateTime         @updatedAt

  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignments  UserRoleAssignment[]

  @@unique([organizationId, key])
  @@map("role_profiles")
}

model UserRoleAssignment {
  id            String   @id @default(cuid())
  userId        String   @unique
  roleProfileId String
  assignedById  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleProfile RoleProfile @relation(fields: [roleProfileId], references: [id], onDelete: Cascade)

  @@index([roleProfileId])
  @@map("user_role_assignments")
}

// ─── CRM Entities ────────────────────────────────────────────────────────────

model Account {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  normalizedName  String
  domain          String?
  salesforceId    String?
  hubspotId       String?
  mergeAccountId  String?
  industry        String?
  employeeCount   Int?
  annualRevenue   Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  contacts         Contact[]
  calls            Call[]
  salesforceEvents SalesforceEvent[]
  stories          Story[]
  domainAliases    AccountDomain[]
  userAccess       UserAccountAccess[]
  storyRegenLogs   StoryRegenLog[]

  @@unique([organizationId, domain])
  @@unique([organizationId, salesforceId])
  @@index([organizationId, normalizedName])
  @@map("accounts")
}

model AccountDomain {
  id        String @id @default(cuid())
  accountId String
  domain    String

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, domain])
  @@index([domain])
  @@map("account_domains")
}

model Contact {
  id             String   @id @default(cuid())
  accountId      String
  email          String
  emailDomain    String
  name           String?
  title          String?
  phone          String?
  salesforceId   String?
  hubspotId      String?
  mergeContactId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  account          Account           @relation(fields: [accountId], references: [id])
  callParticipants CallParticipant[]

  @@unique([accountId, email])
  @@index([emailDomain])
  @@map("contacts")
}

// ─── Calls & Transcripts ─────────────────────────────────────────────────────

model Call {
  id               String       @id @default(cuid())
  organizationId   String
  accountId        String?
  title            String?
  provider         CallProvider
  mergeRecordingId String?      @unique
  externalId       String?
  recordingUrl     String?
  duration         Int?
  occurredAt       DateTime
  matchMethod      MatchMethod  @default(NONE)
  matchConfidence  Float        @default(0)
  dismissedAt      DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id])
  account      Account?          @relation(fields: [accountId], references: [id])
  transcript   Transcript?
  participants CallParticipant[]
  tags         CallTag[]

  @@index([organizationId, accountId])
  @@index([organizationId, occurredAt])
  @@index([organizationId, matchMethod, matchConfidence])
  @@map("calls")
}

enum MatchMethod {
  NONE
  EMAIL_DOMAIN
  FUZZY_NAME
  MANUAL
}

enum CallProvider {
  GONG
  GRAIN
  CHORUS
  ZOOM
  GOOGLE_MEET
  TEAMS
  FIREFLIES
  DIALPAD
  AIRCALL
  RINGCENTRAL
  SALESLOFT
  OUTREACH
  OTHER
}

model CallParticipant {
  id        String  @id @default(cuid())
  callId    String
  contactId String?
  email     String?
  name      String?
  isHost    Boolean @default(false)

  call    Call     @relation(fields: [callId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id])

  @@index([callId])
  @@index([email])
  @@map("call_participants")
}

model Transcript {
  id         String   @id @default(cuid())
  callId     String   @unique
  fullText   String
  language   String   @default("en")
  wordCount  Int
  createdAt  DateTime @default(now())

  call   Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  chunks TranscriptChunk[]

  @@map("transcripts")
}

model TranscriptChunk {
  id           String   @id @default(cuid())
  transcriptId String
  chunkIndex   Int
  text         String
  speaker      String?
  startMs      Int?
  endMs        Int?
  embeddingId  String?
  createdAt    DateTime @default(now())

  transcript Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)
  tags       ChunkTag[]

  @@unique([transcriptId, chunkIndex])
  @@map("transcript_chunks")
}

// ─── Taxonomy Tags ───────────────────────────────────────────────────────────

model CallTag {
  id          String      @id @default(cuid())
  callId      String
  funnelStage FunnelStage
  topic       String
  confidence  Float
  createdAt   DateTime    @default(now())

  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@unique([callId, funnelStage, topic])
  @@index([funnelStage])
  @@map("call_tags")
}

model ChunkTag {
  id          String      @id @default(cuid())
  chunkId     String
  funnelStage FunnelStage
  topic       String
  confidence  Float
  createdAt   DateTime    @default(now())

  chunk TranscriptChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@unique([chunkId, funnelStage, topic])
  @@map("chunk_tags")
}

enum FunnelStage {
  TOFU
  MOFU
  BOFU
  POST_SALE
  INTERNAL
  VERTICAL
}

// ─── CRM Events ──────────────────────────────────────────────────────────────

model SalesforceEvent {
  id            String              @id @default(cuid())
  accountId     String
  eventType     SalesforceEventType
  stageName     String?
  opportunityId String?
  amount        Float?
  closeDate     DateTime?
  description   String?
  rawPayload    Json?
  createdAt     DateTime            @default(now())

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId, eventType])
  @@map("salesforce_events")
}

enum SalesforceEventType {
  OPPORTUNITY_CREATED
  OPPORTUNITY_STAGE_CHANGE
  CLOSED_WON
  CLOSED_LOST
  CONTACT_CREATED
  LEAD_CONVERTED
  TASK_COMPLETED
  NOTE_ADDED
}

// ─── Generated Stories ───────────────────────────────────────────────────────

model Story {
  id             String        @id @default(cuid())
  organizationId String
  accountId      String
  title          String
  markdownBody   String
  storyType      StoryType
  funnelStages   FunnelStage[]
  filterTags     String[]
  aiProvider     String?
  aiModel        String?
  generatedById  String?
  confidenceScore Float         @default(0.5)
  lineageSummary  Json?
  generatedAt    DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id])
  account      Account        @relation(fields: [accountId], references: [id])
  quotes       HighValueQuote[]
  landingPages LandingPage[]
  claimLineage StoryClaimLineage[]
  qualityFeedback StoryQualityFeedback[]

  @@index([organizationId, accountId])
  @@index([organizationId, generatedById])
  @@map("stories")
}

enum StoryType {
  FULL_JOURNEY
  ONBOARDING
  ROI_ANALYSIS
  COMPETITIVE_WIN
  EXPANSION
  CUSTOM
}

model HighValueQuote {
  id          String   @id @default(cuid())
  storyId     String
  speaker     String?
  quoteText   String
  context     String?
  metricType  String?
  metricValue String?
  callId      String?
  createdAt   DateTime @default(now())
  confidenceScore Float @default(0.6)
  lineageMetadata Json?

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("high_value_quotes")
}

model StoryClaimLineage {
  id             String   @id @default(cuid())
  organizationId String
  storyId        String
  claimType      String
  claimText      String
  sourceCallId   String?
  sourceChunkId  String?
  sourceTimestampMs Int?
  confidenceScore Float  @default(0.5)
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  story        Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([organizationId, storyId, createdAt])
  @@index([organizationId, sourceCallId])
  @@map("story_claim_lineage")
}

model StoryQualityFeedback {
  id             String   @id @default(cuid())
  organizationId String
  storyId        String
  submittedByUserId String?
  feedbackType   String
  targetType     String
  targetId       String?
  originalValue  String?
  correctedValue String?
  notes          String?
  applyToPromptTuning Boolean @default(false)
  status         String   @default("OPEN")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  story        Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  submittedBy  User?        @relation("StoryFeedbackSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, status, createdAt])
  @@index([organizationId, storyId, createdAt])
  @@map("story_quality_feedback")
}

// ─── Landing Pages (Publishable Story Pages) ────────────────────────────────

model LandingPage {
  id                 String         @id @default(cuid())
  organizationId     String
  storyId            String
  createdById        String
  slug               String         @unique
  title              String
  subtitle           String?
  editableBody       String
  scrubbedBody       String
  scrubbedTitle      String?
  scrubbedSubtitle   String?
  heroImageUrl       String?
  calloutBoxes       Json?
  scrubbedCalloutBoxes Json?
  totalCallHours     Float          @default(0)
  visibility         PageVisibility @default(PRIVATE)
  status             PageStatus     @default(DRAFT)
  password           String?
  includeCompanyName Boolean        @default(false)
  noIndex            Boolean        @default(true)
  customCss          String?
  viewCount          Int            @default(0)
  publishedAt        DateTime?
  expiresAt          DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id])
  story        Story              @relation(fields: [storyId], references: [id])
  createdBy    User               @relation("CreatedBy", fields: [createdById], references: [id])
  edits        LandingPageEdit[]
  artifactVersions PublishedArtifactVersion[]

  @@index([organizationId, status])
  @@index([slug])
  @@map("landing_pages")
}

enum ArtifactType {
  LANDING_PAGE
}

model ArtifactGovernancePolicy {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  artifactType         ArtifactType @default(LANDING_PAGE)
  approvalChainEnabled Boolean      @default(false)
  maxExpirationDays    Int?
  requireProvenance    Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  approvalSteps ArtifactApprovalStep[]

  @@index([organizationId, artifactType])
  @@map("artifact_governance_policies")
}

model ArtifactApprovalStep {
  id                      String   @id @default(cuid())
  governancePolicyId      String
  organizationId          String
  stepOrder               Int
  minApprovals            Int      @default(1)
  requiredRoleProfileKey  String?
  requiredUserRole        UserRole?
  approverScopeType       String   @default("ROLE_PROFILE")
  approverScopeValue      String?
  allowSelfApproval       Boolean  @default(false)
  enabled                 Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  governancePolicy ArtifactGovernancePolicy @relation(fields: [governancePolicyId], references: [id], onDelete: Cascade)
  organization     Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, stepOrder, enabled])
  @@unique([governancePolicyId, stepOrder])
  @@map("artifact_approval_steps")
}

model ApprovalGroup {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  ownerUserId    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner        User?        @relation("ApprovalGroupOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  members      ApprovalGroupMember[]

  @@unique([organizationId, name])
  @@index([organizationId, createdAt])
  @@map("approval_groups")
}

model ApprovalGroupMember {
  id             String   @id @default(cuid())
  organizationId String
  groupId        String
  userId         String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  group        ApprovalGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([organizationId, userId])
  @@map("approval_group_members")
}

model TeamApprovalAdminScope {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  teamKey        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation("TeamApprovalScopeUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, teamKey])
  @@index([organizationId, teamKey])
  @@map("team_approval_admin_scopes")
}

model AccountMergeRun {
  id                 String   @id @default(cuid())
  organizationId     String
  primaryAccountId   String
  secondaryAccountId String
  status             String   @default("COMPLETED")
  initiatedByUserId  String?
  undoneByUserId     String?
  mergePreview       Json?
  movedContactIds    String[] @default([])
  movedCallIds       String[] @default([])
  movedStoryIds      String[] @default([])
  movedLandingPageIds String[] @default([])
  notes              String?
  createdAt          DateTime @default(now())
  undoneAt           DateTime?
  updatedAt          DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId, status, createdAt])
  @@map("account_merge_runs")
}

model PublishedArtifactVersion {
  id                      String       @id @default(cuid())
  organizationId          String
  artifactType            ArtifactType @default(LANDING_PAGE)
  landingPageId           String
  versionNumber           Int
  status                  String       @default("ACTIVE")
  releaseNotes            String?
  titleSnapshot           String
  subtitleSnapshot        String?
  bodySnapshot            String
  calloutBoxesSnapshot    Json?
  visibilitySnapshot      PageVisibility
  expiresAtSnapshot       DateTime?
  publishedAtSnapshot     DateTime?
  sourceEditId            String?
  publishedByUserId       String?
  approvalRequestId       String?
  provenance              Json?
  rolledBackFromVersionId String?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  landingPage   LandingPage  @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  publishedBy   User?        @relation(fields: [publishedByUserId], references: [id], onDelete: SetNull)

  @@unique([landingPageId, versionNumber])
  @@index([organizationId, artifactType, createdAt])
  @@index([landingPageId, status, createdAt])
  @@map("published_artifact_versions")
}

enum PageVisibility {
  PRIVATE
  SHARED_WITH_LINK
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model LandingPageEdit {
  id            String   @id @default(cuid())
  landingPageId String
  editedById    String
  previousBody  String
  newBody       String
  editSummary   String?
  createdAt     DateTime @default(now())

  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  editedBy    User        @relation(fields: [editedById], references: [id])

  @@index([landingPageId])
  @@map("landing_page_edits")
}

model TeamWorkspace {
  id                     String              @id @default(cuid())
  organizationId         String
  name                   String
  description            String?
  team                   WorkspaceTeam
  visibility             WorkspaceVisibility @default(TEAM)
  ownerUserId            String
  savedViewConfig        Json?
  allowedRoleProfileKeys String[]            @default([])
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner        User         @relation("WorkspaceOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  assets       SharedAsset[]

  @@index([organizationId, team, visibility])
  @@index([organizationId, ownerUserId])
  @@map("team_workspaces")
}

model SharedAsset {
  id               String    @id @default(cuid())
  organizationId   String
  workspaceId      String?
  ownerUserId      String
  assetType        AssetType
  title            String
  description      String?
  sourceStoryId    String?
  sourcePageId     String?
  sourceAccountId  String?
  visibility       WorkspaceVisibility @default(TEAM)
  allowedRoleProfileKeys String[] @default([])
  metadata         Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workspace    TeamWorkspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  owner        User          @relation("AssetOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)

  @@index([organizationId, assetType, visibility])
  @@index([organizationId, workspaceId])
  @@map("shared_assets")
}

model AutomationRule {
  id             String             @id @default(cuid())
  organizationId String
  name           String
  description    String?
  enabled        Boolean            @default(true)
  triggerType    AutomationTriggerType
  metric         String?
  operator       String?
  threshold      Float?
  scheduleCron   String?
  eventType      String?
  deliveryType   AutomationDeliveryType
  deliveryTarget String
  payloadTemplate Json?
  lastRunAt      DateTime?
  lastRunStatus  String?
  lastRunError   String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, enabled, triggerType])
  @@map("automation_rules")
}

enum AutomationTriggerType {
  THRESHOLD
  SCHEDULE
  EVENT
}

enum AutomationDeliveryType {
  SLACK
  EMAIL
  WEBHOOK
}

enum WorkspaceTeam {
  REVOPS
  MARKETING
  SALES
  CS
}

enum WorkspaceVisibility {
  PRIVATE
  TEAM
  ORG
}

enum AssetType {
  STORY
  PAGE
  REPORT
  PLAYBOOK
  TEMPLATE
}

// ─── Permissions & Org Settings ──────────────────────────────────────────────

model OrgSettings {
  id                        String                   @id @default(cuid())
  organizationId            String                   @unique
  landingPagesEnabled       Boolean                  @default(true)
  defaultPageVisibility     PageVisibility           @default(PRIVATE)
  requireApprovalToPublish  Boolean                  @default(false)
  allowedPublishers         UserRole[]               @default([OWNER, ADMIN])
  maxPagesPerUser           Int?
  companyNameReplacements   Json?
  anonymizationEnabled      Boolean                  @default(true)
  transcriptMergeMaxWords   Int                      @default(600000)
  transcriptTruncationMode  TranscriptTruncationMode @default(OLDEST_FIRST)
  dataGovernancePolicy      Json?
  securityPolicy            Json?
  storyContext              Json?
  storyPromptDefaults       Json?
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("org_settings")
}

enum TranscriptTruncationMode {
  OLDEST_FIRST
  NEWEST_FIRST
}

model UserPermission {
  id          String         @id @default(cuid())
  userId      String
  permission  PermissionType
  grantedById String?
  createdAt   DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@map("user_permissions")
}

model SupportImpersonationSession {
  id               String   @id @default(cuid())
  organizationId   String
  actorUserId      String
  targetUserId     String
  revokedByUserId  String?
  sessionTokenHash String   @unique
  reason           String
  scope            Json?
  lastUsedAt       DateTime?
  startedAt        DateTime @default(now())
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actorUser    User         @relation("SupportImpersonationActor", fields: [actorUserId], references: [id], onDelete: Cascade)
  targetUser   User         @relation("SupportImpersonationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  revokedByUser User?       @relation("SupportImpersonationRevokedBy", fields: [revokedByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId, actorUserId, revokedAt])
  @@index([organizationId, targetUserId, revokedAt])
  @@index([organizationId, expiresAt])
  @@map("support_impersonation_sessions")
}

enum PermissionType {
  CREATE_LANDING_PAGE
  PUBLISH_LANDING_PAGE
  PUBLISH_NAMED_LANDING_PAGE
  EDIT_ANY_LANDING_PAGE
  DELETE_ANY_LANDING_PAGE
  MANAGE_PERMISSIONS
  VIEW_ANALYTICS
  MANAGE_ENTITY_RESOLUTION
  MANAGE_AI_SETTINGS
}

// ─── Account-Scoped Access Control ───────────────────────────────────────────

model UserAccountAccess {
  id               String           @id @default(cuid())
  userId           String
  organizationId   String
  scopeType        AccountScopeType
  accountId        String?
  crmReportId      String?
  crmProvider      CRMProvider?
  crmReportName    String?
  cachedAccountIds String[]         @default([])
  lastSyncedAt     DateTime?
  grantedById      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account? @relation(fields: [accountId], references: [id])

  @@index([userId, organizationId])
  @@index([userId, accountId])
  @@map("user_account_access")
}

enum AccountScopeType {
  ALL_ACCOUNTS
  SINGLE_ACCOUNT
  ACCOUNT_LIST
  CRM_REPORT
}

enum CRMProvider {
  SALESFORCE
  HUBSPOT
}

// ─── Subscriptions & Billing ─────────────────────────────────────────────────

model Subscription {
  id                   String             @id @default(cuid())
  organizationId       String
  stripeSubscriptionId String?            @unique
  pricingModel         PricingModel
  billingChannel       BillingChannel
  status               SubscriptionStatus @default(ACTIVE)
  seatCount            Int?
  seatUnitPrice        Int?
  meteredUnitPrice     Int?
  includedUnits        Int?
  contractValue        Int?
  billingInterval      BillingInterval    @default(MONTHLY)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  canceledAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, status])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum BillingInterval {
  MONTHLY
  QUARTERLY
  ANNUAL
}

model UsageRecord {
  id                String      @id @default(cuid())
  organizationId    String
  metric            UsageMetric
  quantity          Float
  periodStart       DateTime
  periodEnd         DateTime
  reportedToStripe  Boolean     @default(false)
  stripeRecordId    String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, periodStart])
  @@index([reportedToStripe])
  @@map("usage_records")
}

enum UsageMetric {
  TRANSCRIPT_MINUTES
  CALLS_PROCESSED
  STORIES_GENERATED
  PAGES_PUBLISHED
  AI_TOKENS_USED
}

// ─── API Keys (External RAG Consumers) ──────────────────────────────────────

model ApiKey {
  id               String    @id @default(cuid())
  organizationId   String
  keyHash          String    @unique
  keyPrefix        String
  label            String
  scopes           String[]  @default(["rag:query"])
  expiresAt        DateTime?
  revokedAt        DateTime?
  lastUsedAt       DateTime?
  replacedByKeyId  String?   @unique
  gracePeriodEndsAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  organization  Organization @relation(fields: [organizationId], references: [id])
  replacedByKey ApiKey?      @relation("KeyRotation", fields: [replacedByKeyId], references: [id])
  replacesKey   ApiKey?      @relation("KeyRotation")
  usageLogs     ApiUsageLog[]

  @@index([organizationId])
  @@map("api_keys")
}

model ApiUsageLog {
  id             String   @id @default(cuid())
  apiKeyId       String
  organizationId String
  endpoint       String
  method         String
  statusCode     Int
  tokensUsed     Int?
  responseTimeMs Int?
  createdAt      DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id])

  @@index([apiKeyId, createdAt])
  @@index([organizationId, createdAt])
  @@map("api_usage_logs")
}

// ─── Merge.dev Linked Accounts ──────────────────────────────────────────────

model LinkedAccount {
  id                   String              @id @default(cuid())
  organizationId       String
  mergeLinkedAccountId String              @unique
  accountToken         String
  integrationSlug      String
  category             MergeCategory
  status               LinkedAccountStatus @default(ACTIVE)
  lastSyncedAt         DateTime?
  initialSyncDone      Boolean             @default(false)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, category])
  @@index([status])
  @@map("linked_accounts")
}

enum MergeCategory {
  CRM
  RECORDING
}

enum LinkedAccountStatus {
  ACTIVE
  PAUSED
  ERROR
  REVOKED
}

// ─── Integration Configurations ─────────────────────────────────────────────

model IntegrationConfig {
  id             String              @id @default(cuid())
  organizationId String
  provider       IntegrationProvider
  enabled        Boolean             @default(true)
  credentials    Json
  settings       Json?
  lastSyncAt     DateTime?
  syncCursor     String?
  webhookSecret  String?
  status         IntegrationStatus   @default(PENDING_SETUP)
  lastError      String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  runs         IntegrationRun[]

  @@unique([organizationId, provider])
  @@map("integration_configs")
}

enum IntegrationProvider {
  GRAIN
  GONG
  SALESFORCE
  MERGE_DEV
}

enum IntegrationStatus {
  PENDING_SETUP
  ACTIVE
  ERROR
  DISABLED
}

// ─── Organization Invites ─────────────────────────────────────────────────────

model OrgInvite {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           UserRole  @default(MEMBER)
  invitedById    String
  token          String    @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, email])
  @@map("org_invites")
}

// ─── Connections Setup Wizard ─────────────────────────────────────────────────

model SetupWizard {
  id                      String          @id @default(cuid())
  organizationId          String          @unique
  currentStep             SetupWizardStep @default(RECORDING_PROVIDER)
  completedAt             DateTime?
  recordingProvider       CallProvider?
  mergeLinkedAccountId    String?
  crmProvider             CRMProvider?
  crmMergeLinkedAccountId String?
  syncedAccountCount      Int             @default(0)
  unresolvedCount         Int             @default(0)
  syncReviewedAt          DateTime?
  selectedPlan            Plan?
  permissionsConfiguredAt DateTime?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("setup_wizards")
}

enum SetupWizardStep {
  RECORDING_PROVIDER
  CRM
  ACCOUNT_SYNC
  PLAN
  PERMISSIONS
  COMPLETED
}

// ─── Weekly Story Regeneration ───────────────────────────────────────────────

model StoryRegenLog {
  id              String   @id @default(cuid())
  organizationId  String
  accountId       String
  previousStoryId String?
  newStoryId      String
  callsProcessed  Int
  diffSummary     String?
  createdAt       DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  account      Account      @relation(fields: [accountId], references: [id])

  @@index([organizationId, createdAt])
  @@map("story_regen_logs")
}

// ─── Notifications ──────────────────────────────────────────────────────────

model Notification {
  id             String           @id @default(cuid())
  organizationId String
  userId         String?
  type           NotificationType
  title          String
  body           String
  metadata       Json?
  read           Boolean          @default(false)
  createdAt      DateTime         @default(now())

  @@index([organizationId, userId, read])
  @@index([organizationId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  STORY_COMPLETED
  CALL_PROCESSED
  CALL_PROCESSING_FAILED
  TRIAL_EXPIRING
  TRIAL_EXPIRED
  PAGE_PUBLISHED
  PAGE_NEEDS_APPROVAL
  EXPORT_READY
  SYSTEM_ALERT
}

// ─── Confidence Calibration ─────────────────────────────────────────────────

model ValidationSample {
  id                  String   @id @default(cuid())
  chunkText           String
  expectedFunnelStage String
  expectedTopic       String
  organizationId      String?
  createdAt           DateTime @default(now())

  @@index([expectedFunnelStage, expectedTopic])
  @@map("validation_samples")
}

// ═════════════════════════════════════════════════════════════════════════════
// AI PROVIDER CONFIGURATION, BILLING & USAGE
// ═════════════════════════════════════════════════════════════════════════════

enum AIProviderType {
  OPENAI
  ANTHROPIC
  GOOGLE
}

model PlatformAIProvider {
  id              String         @id @default(cuid())
  provider        AIProviderType
  encryptedApiKey String
  keyIv           String
  keyAuthTag      String
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  models PlatformModelPricing[]

  @@unique([provider])
  @@map("platform_ai_providers")
}

model PlatformModelPricing {
  id                    String         @id @default(cuid())
  platformProviderId    String
  provider              AIProviderType
  modelId               String
  displayName           String
  inputCostPer1kTokens  Float
  outputCostPer1kTokens Float
  isAvailable           Boolean        @default(true)
  sortOrder             Int            @default(0)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  platformProvider PlatformAIProvider @relation(fields: [platformProviderId], references: [id], onDelete: Cascade)

  @@unique([provider, modelId])
  @@map("platform_model_pricing")
}

model OrgAISettings {
  id                         String   @id @default(cuid())
  organizationId             String   @unique
  defaultProvider            String?
  defaultModel               String?
  perSeatTokenBudgetPerMonth Int?
  perSeatStoriesPerMonth     Int?
  maxStoriesPerMonth         Int?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("org_ai_settings")
}

model OrgAIRoleDefault {
  id                String           @id @default(cuid())
  organizationId    String
  role              UserRole
  allowedProviders  AIProviderType[]
  allowedModels     String[]
  maxTokensPerDay   Int?
  maxTokensPerMonth Int?
  maxStoriesPerMonth Int?
  maxRequestsPerDay Int?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, role])
  @@map("org_ai_role_defaults")
}

model UserAIAccess {
  id               String           @id @default(cuid())
  organizationId   String
  userId           String
  allowedProviders AIProviderType[]
  allowedModels    String[]
  deniedProviders  AIProviderType[]
  deniedModels     String[]
  grantedById      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("user_ai_access")
}

model AIProviderConfig {
  id              String         @id @default(cuid())
  organizationId  String
  provider        AIProviderType
  encryptedApiKey String
  keyIv           String
  keyAuthTag      String
  displayName     String?
  defaultModel    String?
  embeddingModel  String?
  isDefault       Boolean        @default(false)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, provider])
  @@map("ai_provider_configs")
}

model UserAIBalance {
  id                 String   @id @default(cuid())
  organizationId     String
  userId             String
  balanceCents       Int      @default(0)
  lifetimeSpentCents Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id])
  organization Organization        @relation(fields: [organizationId], references: [id])
  transactions UserAITransaction[]

  @@unique([organizationId, userId])
  @@map("user_ai_balances")
}

model UserAITransaction {
  id            String            @id @default(cuid())
  balanceId     String
  type          AITransactionType
  amountCents   Int
  description   String
  usageRecordId String?
  createdAt     DateTime          @default(now())

  balance UserAIBalance @relation(fields: [balanceId], references: [id])

  @@index([balanceId, createdAt])
  @@map("user_ai_transactions")
}

enum AITransactionType {
  CREDIT
  DEBIT
  REFUND
}

enum AIOperation {
  STORY_GENERATION
  QUOTE_EXTRACTION
  TRANSCRIPT_TAGGING
  RAG_QUERY
  EMBEDDING
}

model AIUsageRecord {
  id             String      @id @default(cuid())
  organizationId String
  userId         String
  provider       String
  model          String
  operation      AIOperation
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  costCents      Float       @default(0)
  createdAt      DateTime    @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId, userId, createdAt])
  @@index([organizationId, createdAt])
  @@map("ai_usage_records")
}

model AIUsageLimit {
  id                  String   @id @default(cuid())
  organizationId      String
  userId              String?
  maxTokensPerDay     Int?
  maxTokensPerMonth   Int?
  maxRequestsPerDay   Int?
  maxRequestsPerMonth Int?
  maxStoriesPerMonth  Int?
  warningThresholdPct Int      @default(80)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User?        @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@map("ai_usage_limits")
}

model AIUsageNotification {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  limitType      String
  thresholdPct   Int
  currentUsage   Int
  limitValue     Int
  message        String
  acknowledged   Boolean  @default(false)
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([userId, acknowledged, createdAt])
  @@map("ai_usage_notifications")
}
