generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Auth & Tenancy ──────────────────────────────────────────────────────────

model Organization {
  id               String    @id @default(cuid())
  name             String
  workosOrgId      String?   @unique
  stripeCustomerId String?   @unique
  plan             Plan      @default(FREE_TRIAL)
  trialEndsAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  users        User[]
  accounts     Account[]
  calls        Call[]
  stories      Story[]
  landingPages LandingPage[]
  orgSettings  OrgSettings?

  @@map("organizations")
}

enum Plan {
  FREE_TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  workosUserId   String?  @unique
  organizationId String
  role           UserRole @default(MEMBER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id])
  landingPages      LandingPage[]      @relation("CreatedBy")
  landingPageEdits  LandingPageEdit[]
  permissions       UserPermission[]
  accountAccess     UserAccountAccess[]

  @@index([organizationId])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ─── CRM Entities ────────────────────────────────────────────────────────────

model Account {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  normalizedName  String   // lowercase, stripped of Inc/Corp/LLC suffixes
  domain          String?  // primary email domain (e.g., "bigtech.com")
  salesforceId    String?
  hubspotId       String?
  mergeAccountId  String?
  industry        String?
  employeeCount   Int?
  annualRevenue   Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization     @relation(fields: [organizationId], references: [id])
  contacts        Contact[]
  calls           Call[]
  salesforceEvents SalesforceEvent[]
  stories         Story[]
  domainAliases   AccountDomain[]
  userAccess      UserAccountAccess[]

  @@unique([organizationId, domain])
  @@unique([organizationId, salesforceId])
  @@index([organizationId, normalizedName])
  @@map("accounts")
}

model AccountDomain {
  id        String @id @default(cuid())
  accountId String
  domain    String // additional email domains for the same account

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, domain])
  @@index([domain])
  @@map("account_domains")
}

model Contact {
  id             String   @id @default(cuid())
  accountId      String
  email          String
  emailDomain    String   // extracted domain portion
  name           String?
  title          String?
  phone          String?
  salesforceId   String?
  hubspotId      String?
  mergeContactId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  account        Account           @relation(fields: [accountId], references: [id])
  callParticipants CallParticipant[]

  @@unique([accountId, email])
  @@index([emailDomain])
  @@map("contacts")
}

// ─── Calls & Transcripts ─────────────────────────────────────────────────────

model Call {
  id               String       @id @default(cuid())
  organizationId   String
  accountId        String?      // resolved via Entity Resolution; null until matched
  title            String?
  provider         CallProvider
  mergeRecordingId String?      @unique
  externalId       String?      // provider-native ID
  recordingUrl     String?
  duration         Int?         // seconds
  occurredAt       DateTime
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id])
  account      Account?          @relation(fields: [accountId], references: [id])
  transcript   Transcript?
  participants CallParticipant[]
  tags         CallTag[]

  @@index([organizationId, accountId])
  @@index([organizationId, occurredAt])
  @@map("calls")
}

enum CallProvider {
  GONG
  CHORUS
  ZOOM
  GOOGLE_MEET
  TEAMS
  FIREFLIES
  DIALPAD
  AIRCALL
  RINGCENTRAL
  SALESLOFT
  OUTREACH
  OTHER
}

model CallParticipant {
  id        String  @id @default(cuid())
  callId    String
  contactId String?
  email     String?
  name      String?
  isHost    Boolean @default(false)

  call    Call     @relation(fields: [callId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id])

  @@index([callId])
  @@index([email])
  @@map("call_participants")
}

model Transcript {
  id         String   @id @default(cuid())
  callId     String   @unique
  fullText   String   // complete transcript text
  language   String   @default("en")
  wordCount  Int
  createdAt  DateTime @default(now())

  call   Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  chunks TranscriptChunk[]

  @@map("transcripts")
}

model TranscriptChunk {
  id           String   @id @default(cuid())
  transcriptId String
  chunkIndex   Int
  text         String
  speaker      String?
  startMs      Int?     // timestamp offset in milliseconds
  endMs        Int?
  embeddingId  String?  // Pinecone vector ID
  createdAt    DateTime @default(now())

  transcript Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)
  tags       ChunkTag[]

  @@unique([transcriptId, chunkIndex])
  @@map("transcript_chunks")
}

// ─── Taxonomy Tags ───────────────────────────────────────────────────────────

model CallTag {
  id         String        @id @default(cuid())
  callId     String
  funnelStage FunnelStage
  topic      String        // specific topic from taxonomy
  confidence Float         // LLM confidence 0.0-1.0
  createdAt  DateTime      @default(now())

  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@unique([callId, funnelStage, topic])
  @@index([funnelStage])
  @@map("call_tags")
}

model ChunkTag {
  id         String      @id @default(cuid())
  chunkId    String
  funnelStage FunnelStage
  topic      String
  confidence Float
  createdAt  DateTime    @default(now())

  chunk TranscriptChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

  @@unique([chunkId, funnelStage, topic])
  @@map("chunk_tags")
}

enum FunnelStage {
  TOFU       // Top of Funnel
  MOFU       // Mid-Funnel
  BOFU       // Bottom of Funnel
  POST_SALE
  INTERNAL
  VERTICAL   // Vertical/Segment cuts
}

// ─── CRM Events ──────────────────────────────────────────────────────────────

model SalesforceEvent {
  id            String          @id @default(cuid())
  accountId     String
  eventType     SalesforceEventType
  stageName     String?         // e.g., "Closed Won", "Closed Lost"
  opportunityId String?
  amount        Float?
  closeDate     DateTime?
  description   String?
  rawPayload    Json?
  createdAt     DateTime        @default(now())

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId, eventType])
  @@map("salesforce_events")
}

enum SalesforceEventType {
  OPPORTUNITY_CREATED
  OPPORTUNITY_STAGE_CHANGE
  CLOSED_WON
  CLOSED_LOST
  CONTACT_CREATED
  LEAD_CONVERTED
  TASK_COMPLETED
  NOTE_ADDED
}

// ─── Generated Stories ───────────────────────────────────────────────────────

model Story {
  id             String      @id @default(cuid())
  organizationId String
  accountId      String
  title          String
  markdownBody   String      // the generated Markdown story
  storyType      StoryType
  funnelStages   FunnelStage[] // which stages this story covers
  filterTags     String[]    // which taxonomy topics were used to filter
  generatedAt    DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  account      Account      @relation(fields: [accountId], references: [id])
  quotes       HighValueQuote[]
  landingPages LandingPage[]

  @@index([organizationId, accountId])
  @@map("stories")
}

enum StoryType {
  FULL_JOURNEY
  ONBOARDING
  ROI_ANALYSIS
  COMPETITIVE_WIN
  EXPANSION
  CUSTOM
}

model HighValueQuote {
  id          String   @id @default(cuid())
  storyId     String
  speaker     String?
  quoteText   String
  context     String?  // surrounding context
  metricType  String?  // e.g., "cost_savings", "time_saved", "revenue"
  metricValue String?  // e.g., "40%", "$2M", "3x"
  callId      String?  // source call
  createdAt   DateTime @default(now())

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("high_value_quotes")
}

// ─── Landing Pages (Publishable Story Pages) ────────────────────────────────

model LandingPage {
  id              String            @id @default(cuid())
  organizationId  String
  storyId         String
  createdById     String
  slug            String            @unique   // URL slug: /s/{slug}
  title           String
  subtitle        String?
  editableBody    String            // rich Markdown edited by the rep
  scrubbedBody    String            // company-name-scrubbed version for public
  heroImageUrl    String?
  calloutBoxes    Json?             // array of {title, body, icon} callout blocks
  totalCallHours  Float             @default(0) // for the "Compiled from X hours" badge
  visibility      PageVisibility    @default(PRIVATE)
  status          PageStatus        @default(DRAFT)
  password        String?           // optional password for SHARED_WITH_LINK pages
  includeCompanyName Boolean        @default(false) // admin-only: named landing page
  noIndex         Boolean           @default(true)
  customCss       String?
  viewCount       Int               @default(0)
  publishedAt     DateTime?
  expiresAt       DateTime?         // optional expiration for shared links
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  organization Organization       @relation(fields: [organizationId], references: [id])
  story        Story               @relation(fields: [storyId], references: [id])
  createdBy    User                @relation("CreatedBy", fields: [createdById], references: [id])
  edits        LandingPageEdit[]

  @@index([organizationId, status])
  @@index([slug])
  @@map("landing_pages")
}

enum PageVisibility {
  PRIVATE           // only visible to org members
  SHARED_WITH_LINK  // anyone with the link (optionally password-protected)
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model LandingPageEdit {
  id            String   @id @default(cuid())
  landingPageId String
  editedById    String
  previousBody  String   // snapshot before this edit
  newBody       String   // snapshot after this edit
  editSummary   String?
  createdAt     DateTime @default(now())

  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  editedBy    User        @relation(fields: [editedById], references: [id])

  @@index([landingPageId])
  @@map("landing_page_edits")
}

// ─── Permissions & Org Settings ──────────────────────────────────────────────

model OrgSettings {
  id                        String   @id @default(cuid())
  organizationId            String   @unique
  landingPagesEnabled       Boolean  @default(true)
  defaultPageVisibility     PageVisibility @default(PRIVATE)
  requireApprovalToPublish  Boolean  @default(false)
  allowedPublishers         UserRole[] @default([OWNER, ADMIN]) // roles that can publish
  maxPagesPerUser           Int?     // null = unlimited
  companyNameReplacements   Json?    // custom scrub mappings: {"Acme Corp": "the client"}

  // Transcript merging configuration
  transcriptMergeMaxWords   Int      @default(600000) // max word count for merged transcript markdown
  transcriptTruncationMode  TranscriptTruncationMode @default(OLDEST_FIRST) // which transcripts to drop when over limit

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("org_settings")
}

model UserPermission {
  id             String           @id @default(cuid())
  userId         String
  permission     PermissionType
  grantedById    String?
  createdAt      DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@map("user_permissions")
}

enum PermissionType {
  CREATE_LANDING_PAGE
  PUBLISH_LANDING_PAGE
  PUBLISH_NAMED_LANDING_PAGE  // publish with real company name visible
  EDIT_ANY_LANDING_PAGE
  DELETE_ANY_LANDING_PAGE
  MANAGE_PERMISSIONS
  VIEW_ANALYTICS
}

// ─── Account-Scoped Access Control ───────────────────────────────────────────
// Admins can restrict which accounts a user can generate landing pages for.
// Access can be granted to individual accounts or via a CRM report/list.

model UserAccountAccess {
  id             String           @id @default(cuid())
  userId         String
  organizationId String
  scopeType      AccountScopeType
  // For SINGLE_ACCOUNT: the specific account
  accountId      String?
  // For CRM_REPORT: the Salesforce report ID or HubSpot list ID
  crmReportId    String?
  crmProvider    CRMProvider?
  crmReportName  String?          // human-readable name for display
  // Cached account IDs from the last CRM report sync
  cachedAccountIds String[]       @default([])
  lastSyncedAt   DateTime?
  grantedById    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account? @relation(fields: [accountId], references: [id])

  @@index([userId, organizationId])
  @@index([userId, accountId])
  @@map("user_account_access")
}

enum AccountScopeType {
  ALL_ACCOUNTS       // no restriction (default for admins)
  SINGLE_ACCOUNT     // access to one specific account
  ACCOUNT_LIST       // access to a manually curated list (stored in cachedAccountIds)
  CRM_REPORT         // access defined by a Salesforce report or HubSpot list
}

enum CRMProvider {
  SALESFORCE
  HUBSPOT
}

enum TranscriptTruncationMode {
  OLDEST_FIRST  // drop earliest transcripts when over limit
  NEWEST_FIRST  // drop latest transcripts when over limit
}
